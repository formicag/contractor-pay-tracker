{% extends "base.html" %}

{% block title %}Umbrella Dashboard - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
    /* Umbrella Tiles Grid */
    .umbrella-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(800px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    /* Umbrella Tile Card */
    .umbrella-tile {
        background: var(--bg-secondary);
        border-radius: 0.5rem;
        border: 1px solid var(--border);
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        transition: all 0.2s ease;
    }

    .umbrella-tile:hover {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
        border-color: var(--accent);
    }

    /* Umbrella Header */
    .umbrella-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border);
    }

    .umbrella-name {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .umbrella-code {
        font-size: 0.875rem;
        color: var(--text-muted);
        font-weight: 500;
        background: var(--bg-tertiary);
        padding: 0.25rem 0.75rem;
        border-radius: 0.25rem;
    }

    .resource-count {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: 1rem;
    }

    .resource-count .count {
        font-weight: 700;
        color: var(--accent);
        font-size: 1rem;
    }

    /* Monthly Timeline */
    .monthly-timeline {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 0.5rem;
    }

    .month-block {
        background: var(--bg-tertiary);
        border-radius: 0.375rem;
        padding: 0.75rem;
        text-align: center;
        border: 1px solid var(--border);
        transition: all 0.2s ease;
    }

    .month-block:hover {
        background: var(--bg-primary);
        border-color: var(--accent);
    }

    .month-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        margin-bottom: 0.25rem;
        letter-spacing: 0.05em;
    }

    .month-amount {
        font-size: 0.875rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .month-amount.has-data {
        color: var(--success);
    }

    .month-amount.no-data {
        color: var(--text-muted);
        opacity: 0.5;
    }

    /* Summary Section */
    .summary-section {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .total-paid {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .total-paid .amount {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--success);
        margin-left: 0.5rem;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: var(--bg-secondary);
        border-radius: 0.5rem;
        border: 1px solid var(--border);
    }

    .empty-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-state h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: var(--text-secondary);
    }

    /* Loading State */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(15, 20, 25, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .loading-content {
        text-align: center;
        color: var(--text-primary);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .umbrella-grid {
            grid-template-columns: 1fr;
        }

        .monthly-timeline {
            grid-template-columns: repeat(3, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h2>Umbrella Company Dashboard</h2>
    <button class="btn" onclick="loadUmbrellaData()">‚Üª Refresh</button>
</div>

<!-- Database Info -->
<div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem;">
    <div style="font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">Database ARN</div>
    <div style="font-family: monospace; font-size: 0.875rem; color: var(--text-primary);" id="db-arn">Loading...</div>
</div>

<!-- Summary Cards -->
<div class="summary-grid" style="margin-bottom: 2rem;">
    <div class="card">
        <div class="card-header">Total Umbrellas</div>
        <div class="card-value" id="total-umbrellas">0</div>
        <div class="card-subtitle">Companies tracked</div>
    </div>
    <div class="card">
        <div class="card-header">Total Files</div>
        <div class="card-value" style="color: var(--accent);" id="total-files">0</div>
        <div class="card-subtitle">Pay files processed</div>
    </div>
    <div class="card">
        <div class="card-header">Total Contractors</div>
        <div class="card-value" style="color: var(--success);" id="total-contractors">0</div>
        <div class="card-subtitle">Active resources</div>
    </div>
    <div class="card">
        <div class="card-header">Months Covered</div>
        <div class="card-value" style="color: var(--warning);" id="total-months">0</div>
        <div class="card-subtitle">Billing periods</div>
    </div>
</div>

<!-- Umbrella Companies Table -->
<div class="table-container" style="overflow-x: auto;">
    <table id="umbrellas-table" style="min-width: 5000px; width: max-content;">
        <thead>
            <tr>
                <th>PK</th>
                <th>SK</th>
                <th>UmbrellaID</th>
                <th>UmbrellaCode</th>
                <th>FileNameVariation</th>
                <th>LegalName</th>
                <th>CompanyRegNo</th>
                <th>VATNo</th>
                <th>RegisteredAddress</th>
                <th>Website</th>
                <th>PrimaryContactEmail</th>
                <th>Contacts</th>
                <th>ContactCount</th>
                <th>IsActive</th>
                <th>EntityType</th>
                <th>CreatedAt</th>
                <th>UpdatedAt</th>
                <th>GSI1PK</th>
                <th>GSI1SK</th>
                <th>GSI2PK</th>
                <th>GSI2SK</th>
            </tr>
        </thead>
        <tbody id="umbrellas-tbody">
            <tr>
                <td colspan="21" style="text-align: center; padding: 2rem;">
                    <div class="spinner"></div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Month ordering for consistent display
    const MONTH_ORDER = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    // Load data on page load
    window.addEventListener('DOMContentLoaded', () => {
        loadDatabaseInfo();
        loadUmbrellaData();
    });

    async function loadDatabaseInfo() {
        try {
            const response = await fetch('/api/database-info');
            const data = await response.json();
            document.getElementById('db-arn').textContent = data.table_arn || 'arn:aws:dynamodb:eu-west-2:016164185850:table/contractor-pay-development';
        } catch (error) {
            document.getElementById('db-arn').textContent = 'Failed to load database ARN';
        }
    }

    async function loadUmbrellaData() {
        const tbody = document.getElementById('umbrellas-tbody');
        tbody.innerHTML = '<tr><td colspan="21" style="text-align: center; padding: 2rem;"><div class="spinner"></div></td></tr>';

        try {
            const response = await fetch('/api/umbrella-stats');
            const data = await response.json();

            if (data.error) {
                tbody.innerHTML = `<tr><td colspan="21" class="alert alert-danger">Failed to load umbrella data: ${data.message || data.error}</td></tr>`;
                return;
            }

            const umbrellas = data.umbrellas || [];
            const months = data.months || [];
            const summary = data.summary || {};

            // Update summary cards
            if (summary.total_umbrellas !== undefined) {
                document.getElementById('total-umbrellas').textContent = summary.total_umbrellas;
                document.getElementById('total-files').textContent = summary.total_files || 0;
                document.getElementById('total-contractors').textContent = summary.total_contractors || 0;
                document.getElementById('total-months').textContent = summary.total_months || 0;
            }

            if (umbrellas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="21" style="text-align: center; padding: 3rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">üè¢</div>
                            <h3 style="color: var(--text-primary); margin-bottom: 0.5rem;">No umbrella company data found</h3>
                            <p style="color: var(--text-secondary);">Upload pay files to see umbrella company statistics</p>
                        </td>
                    </tr>
                `;
                return;
            }

            displayUmbrellaTable(umbrellas, months);

        } catch (error) {
            tbody.innerHTML = `<tr><td colspan="21" class="alert alert-danger">Failed to load umbrella data: ${error.message}</td></tr>`;
        }
    }

    function displayUmbrellaTable(umbrellas, months) {
        const tbody = document.getElementById('umbrellas-tbody');
        const sortedMonths = sortMonths(months);

        let html = '';

        umbrellas.forEach(umbrella => {
            const contactsJson = JSON.stringify(umbrella.contacts || []);
            const statusBadge = umbrella.is_active
                ? '<span class="badge badge-success">Active</span>'
                : '<span class="badge badge-info">Inactive</span>';

            html += `
                <tr>
                    <td>${umbrella.pk || 'N/A'}</td>
                    <td>${umbrella.sk || 'N/A'}</td>
                    <td>${umbrella.umbrella_id || 'N/A'}</td>
                    <td style="font-family: monospace; font-weight: 600;"><strong>${umbrella.umbrella_code || 'N/A'}</strong></td>
                    <td>${umbrella.file_name_variation || 'N/A'}</td>
                    <td>${umbrella.legal_name || 'N/A'}</td>
                    <td>${umbrella.company_reg_no || 'N/A'}</td>
                    <td>${umbrella.vat_no || 'N/A'}</td>
                    <td>${umbrella.registered_address || 'N/A'}</td>
                    <td>${umbrella.website || 'N/A'}</td>
                    <td>${umbrella.primary_contact_email || 'N/A'}</td>
                    <td style="font-size: 0.75rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${contactsJson}</td>
                    <td>${umbrella.contact_count || 0}</td>
                    <td>${statusBadge}</td>
                    <td>${umbrella.entity_type || 'N/A'}</td>
                    <td>${umbrella.metadata || 'N/A'}</td>
                    <td>${umbrella.created_at || 'N/A'}</td>
                    <td>${umbrella.updated_at || 'N/A'}</td>
                    <td>${umbrella.gsi1_pk || 'N/A'}</td>
                    <td>${umbrella.gsi1_sk || 'N/A'}</td>
                    <td>${umbrella.gsi2_pk || 'N/A'}</td>
                    <td>${umbrella.gsi2_sk || 'N/A'}</td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
    }

    function editUmbrella(code) {
        alert(`Edit functionality for ${code} coming soon!`);
        // TODO: Implement edit modal or redirect to edit page
    }

    function viewUmbrellaDetails(code) {
        alert(`Detailed view for ${code} coming soon!`);
        // TODO: Implement details modal or redirect to details page
    }

    function sortMonths(months) {
        // Sort months by their position in MONTH_ORDER
        return months.sort((a, b) => {
            const indexA = MONTH_ORDER.indexOf(a);
            const indexB = MONTH_ORDER.indexOf(b);

            // If month not found in standard order, put it at the end
            if (indexA === -1) return 1;
            if (indexB === -1) return -1;

            return indexA - indexB;
        });
    }

    function formatCurrency(amount) {
        if (amount === 0) return '-';

        // Format with thousand separators and 2 decimal places
        const formatted = new Intl.NumberFormat('en-GB', {
            style: 'currency',
            currency: 'GBP',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(amount);

        return formatted;
    }
</script>
{% endblock %}
