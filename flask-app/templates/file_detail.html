{% extends "base.html" %}

{% block title %}File Details - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
    /* Back Link */
    .back-link {
        display: inline-flex;
        align-items: center;
        color: var(--accent);
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 1.5rem;
        transition: color 0.2s ease;
    }

    .back-link:hover {
        color: var(--accent-hover);
    }

    /* File Header Card */
    .file-header {
        background: var(--bg-secondary);
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
        border: 1px solid var(--border);
    }

    .file-header h2 {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 1rem;
    }

    .file-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .file-meta-item {
        padding: 1rem;
        background: var(--bg-tertiary);
        border-radius: 0.375rem;
        border: 1px solid var(--border);
    }

    .file-meta-item strong {
        display: block;
        color: var(--text-secondary);
        font-size: 0.75rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .file-meta-item span {
        color: var(--text-primary);
        font-size: 0.875rem;
        font-weight: 500;
    }

    /* Section Headings */
    .section {
        margin-top: 2rem;
    }

    .section h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .section > p {
        color: var(--text-secondary);
        font-size: 0.875rem;
        margin-bottom: 1rem;
    }

    /* Error and Warning Items */
    .error-item,
    .warning-item {
        padding: 1rem 1.25rem;
        margin-bottom: 0.75rem;
        border-radius: 0.5rem;
        border-left: 4px solid;
        background: var(--bg-secondary);
    }

    .error-item {
        border-left-color: var(--danger);
        background: rgba(239, 68, 68, 0.05);
    }

    .warning-item {
        border-left-color: var(--warning);
        background: rgba(245, 158, 11, 0.05);
    }

    .error-item strong,
    .warning-item strong {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
        font-weight: 600;
        font-size: 0.875rem;
    }

    .error-item p,
    .warning-item p {
        color: var(--text-primary);
        font-size: 0.875rem;
        line-height: 1.5;
        margin: 0;
    }

    .error-item .suggestion,
    .warning-item .resolution {
        color: var(--text-secondary);
        font-style: italic;
        margin-top: 0.5rem;
        font-size: 0.8125rem;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: var(--bg-secondary);
        border-radius: 0.5rem;
        border: 1px solid var(--border);
    }

    .empty-state .success-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    .empty-state h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: var(--text-secondary);
    }

    /* Action Buttons */
    .action-section {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid var(--border);
    }
</style>
{% endblock %}

{% block content %}
<a href="/files" class="back-link">‚Üê Back to Files</a>

<div id="file-detail-container">
    <div class="spinner"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const fileId = "{{ file_id }}";

    window.addEventListener('DOMContentLoaded', () => {
        loadFileDetail();
    });

    async function loadFileDetail() {
        const container = document.getElementById('file-detail-container');

        try {
            const response = await fetch(`/api/file/${fileId}`);
            const file = await response.json();

            displayFileDetail(file);
        } catch (error) {
            container.innerHTML = '<p class="alert alert-error">Failed to load file details: ' + error.message + '</p>';
        }
    }

    function displayFileDetail(file) {
        const container = document.getElementById('file-detail-container');
        const statusBadge = getStatusBadge(file.status);

        let html = `
            <div class="file-header">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="margin: 0;">${file.filename}</h2>
                    ${statusBadge}
                </div>

                <div class="file-meta">
                    <div class="file-meta-item">
                        <strong>Umbrella Company</strong>
                        <span>${file.umbrella}</span>
                    </div>
                    <div class="file-meta-item">
                        <strong>Pay Period</strong>
                        <span>Period ${file.period}</span>
                    </div>
                    <div class="file-meta-item">
                        <strong>Uploaded</strong>
                        <span>${new Date(file.uploaded_at).toLocaleString('en-GB', {
                            day: 'numeric',
                            month: 'short',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</span>
                    </div>
                    <div class="file-meta-item">
                        <strong>Total Records</strong>
                        <span>${file.total_records}</span>
                    </div>
                    <div class="file-meta-item">
                        <strong>Valid Records</strong>
                        <span>${file.valid_records}</span>
                    </div>
                </div>
            </div>
        `;

        // Errors section
        if (file.errors && file.errors.length > 0) {
            html += `
                <div class="section">
                    <h3>‚ùå Validation Errors (${file.errors.length})</h3>
                    <p>These CRITICAL errors blocked the import of all records.</p>
            `;

            file.errors.forEach(error => {
                html += `
                    <div class="error-item">
                        <strong>Row ${error.row_number}: ${error.contractor_name || error.employee_id}</strong>
                        <p>${error.error_message}</p>
                        ${error.suggested_fix ? `<p class="suggestion">üí° ${error.suggested_fix}</p>` : ''}
                    </div>
                `;
            });

            html += `</div>`;
        }

        // Warnings section
        if (file.warnings && file.warnings.length > 0) {
            html += `
                <div class="section">
                    <h3>‚ö†Ô∏è Validation Warnings (${file.warnings.length})</h3>
                    <p>These warnings did not block the import, but should be reviewed.</p>
            `;

            file.warnings.forEach(warning => {
                html += `
                    <div class="warning-item">
                        <strong>Row ${warning.row_number}</strong>
                        <p>${warning.warning_message}</p>
                        ${warning.resolution_notes ? `<p class="resolution">‚úì ${warning.resolution_notes}</p>` : ''}
                    </div>
                `;
            });

            html += `</div>`;
        }

        // Success state
        if ((!file.errors || file.errors.length === 0) && (!file.warnings || file.warnings.length === 0)) {
            html += `
                <div class="section">
                    <div class="empty-state">
                        <div class="success-icon">‚úÖ</div>
                        <h3>All Validations Passed</h3>
                        <p>This file was processed successfully with no errors or warnings.</p>
                    </div>
                </div>
            `;
        }

        // Actions
        html += `
            <div class="action-section">
                <button class="btn btn-danger" onclick="deleteFile()">Delete File</button>
            </div>
        `;

        container.innerHTML = html;
    }

    function getStatusBadge(status) {
        const badges = {
            'COMPLETED': '<span class="badge badge-success">Completed</span>',
            'COMPLETED_WITH_WARNINGS': '<span class="badge badge-warning">Completed with Warnings</span>',
            'ERROR': '<span class="badge badge-error">Error</span>',
            'PROCESSING': '<span class="badge" style="background: #d1ecf1; color: #0c5460;">Processing</span>'
        };

        return badges[status] || status;
    }

    async function deleteFile() {
        if (!confirm('Are you sure you want to delete this file?\n\nThis will mark the file as deleted and deactivate all associated records.')) {
            return;
        }

        try {
            const response = await fetch(`/api/file/${fileId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('File deleted successfully');
                window.location.href = '/files';
            } else {
                const error = await response.json();
                alert('Delete failed: ' + (error.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Delete failed: ' + error.message);
        }
    }
</script>
{% endblock %}
