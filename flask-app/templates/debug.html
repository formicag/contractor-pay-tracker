{% extends "base.html" %}

{% block title %}Debug Interface - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
    /* Three-Panel Layout */
    .debug-container {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1rem;
        height: calc(100vh - 140px);
        overflow: hidden;
    }

    .debug-panel {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .panel-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border);
        background: var(--bg-tertiary);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .panel-header h3 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }

    .panel-content {
        flex: 1;
        overflow: auto;
        padding: 1rem;
    }

    /* File Navigation */
    .file-nav {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        margin-bottom: 1rem;
    }

    .file-select {
        flex: 1;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        color: var(--text-primary);
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
    }

    .nav-btn {
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        color: var(--text-primary);
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .nav-btn:hover:not(:disabled) {
        background: var(--bg-secondary);
        border-color: var(--accent);
        color: var(--accent);
    }

    .nav-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    /* Sheet Tabs */
    .sheet-tabs {
        display: flex;
        gap: 0.25rem;
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--border);
        overflow-x: auto;
        padding-bottom: 0.5rem;
    }

    .sheet-tab {
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        color: var(--text-secondary);
        padding: 0.5rem 1rem;
        border-radius: 0.375rem 0.375rem 0 0;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.875rem;
        font-weight: 500;
        white-space: nowrap;
        border-bottom: none;
    }

    .sheet-tab:hover {
        color: var(--text-primary);
        background: var(--bg-secondary);
    }

    .sheet-tab.active {
        background: var(--bg-primary);
        color: var(--accent);
        border-color: var(--accent);
        border-bottom-color: var(--bg-primary);
    }

    /* Excel Table Styling */
    .excel-container {
        overflow: auto;
        max-height: calc(100vh - 320px);
        border: 1px solid var(--border);
        border-radius: 0.375rem;
    }

    .excel-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.75rem;
        background: var(--bg-primary);
    }

    .excel-table th {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-weight: 600;
        padding: 0.75rem 1rem;
        text-align: left;
        border: 1px solid var(--border);
        position: sticky;
        top: 0;
        z-index: 10;
        white-space: nowrap;
    }

    .excel-table td {
        padding: 0.5rem 1rem;
        border: 1px solid var(--border);
        color: var(--text-primary);
        white-space: nowrap;
    }

    .excel-table tbody tr:hover {
        background: var(--bg-secondary);
    }

    /* Highlight differences */
    .excel-table td.diff {
        background: rgba(239, 68, 68, 0.2);
        border-color: var(--danger);
    }

    .excel-table td.match {
        background: rgba(16, 185, 129, 0.1);
    }

    /* Database Records Table */
    .db-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.75rem;
    }

    .db-table th {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-weight: 600;
        padding: 0.75rem 1rem;
        text-align: left;
        border: 1px solid var(--border);
        position: sticky;
        top: 0;
        white-space: nowrap;
    }

    .db-table td {
        padding: 0.5rem 1rem;
        border: 1px solid var(--border);
        color: var(--text-primary);
    }

    .db-table tbody tr:hover {
        background: var(--bg-secondary);
    }

    /* Loading State */
    .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 4rem 2rem;
        color: var(--text-secondary);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--text-secondary);
    }

    .empty-state h4 {
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        font-size: 1.125rem;
    }

    /* Info Badge */
    .info-badge {
        background: var(--bg-tertiary);
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        color: var(--text-secondary);
        font-weight: 600;
    }

    /* Comparison Summary */
    .comparison-summary {
        background: var(--bg-tertiary);
        padding: 1rem;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
        border: 1px solid var(--border);
    }

    .comparison-summary h4 {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.75rem;
    }

    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 0.75rem;
    }

    .summary-item {
        background: var(--bg-secondary);
        padding: 0.75rem;
        border-radius: 0.375rem;
        border: 1px solid var(--border);
    }

    .summary-item strong {
        display: block;
        color: var(--text-secondary);
        font-size: 0.7rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .summary-item span {
        color: var(--text-primary);
        font-size: 1.25rem;
        font-weight: 700;
    }

    .summary-item.success span {
        color: var(--success);
    }

    .summary-item.warning span {
        color: var(--warning);
    }

    .summary-item.danger span {
        color: var(--danger);
    }

    /* Scrollbar Styling */
    .excel-container::-webkit-scrollbar,
    .panel-content::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    .excel-container::-webkit-scrollbar-track,
    .panel-content::-webkit-scrollbar-track {
        background: var(--bg-tertiary);
    }

    .excel-container::-webkit-scrollbar-thumb,
    .panel-content::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 4px;
    }

    .excel-container::-webkit-scrollbar-thumb:hover,
    .panel-content::-webkit-scrollbar-thumb:hover {
        background: var(--border-light);
    }

    /* Delete Confirmation Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-content {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
    }

    .modal-content h3 {
        margin-top: 0;
        color: var(--text-primary);
    }

    .modal-content p {
        color: var(--text-secondary);
        margin-bottom: 1.5rem;
    }

    .modal-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
    }

    .modal-btn {
        padding: 0.625rem 1.25rem;
        border-radius: 0.375rem;
        border: 1px solid var(--border);
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .modal-btn-cancel {
        background: var(--bg-tertiary);
        color: var(--text-primary);
    }

    .modal-btn-cancel:hover {
        background: var(--bg-secondary);
    }

    .modal-btn-delete {
        background: var(--danger);
        color: white;
        border-color: var(--danger);
    }

    .modal-btn-delete:hover {
        background: #dc2626;
    }

    .file-details {
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 0.375rem;
        padding: 1rem;
        margin: 1rem 0;
    }

    .file-details dt {
        color: var(--text-secondary);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.25rem;
    }

    .file-details dd {
        color: var(--text-primary);
        margin-bottom: 0.75rem;
        font-size: 0.875rem;
    }

    .file-details dd:last-child {
        margin-bottom: 0;
    }

    /* File Metadata Section */
    .file-metadata {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
        display: none;
    }

    .file-metadata.visible {
        display: block;
    }

    .file-metadata h3 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0 0 1rem 0;
        border-bottom: 1px solid var(--border);
        padding-bottom: 0.75rem;
    }

    .metadata-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .metadata-item {
        display: flex;
        flex-direction: column;
    }

    .metadata-item label {
        color: var(--text-secondary);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.375rem;
    }

    .metadata-item .value {
        color: var(--text-primary);
        font-size: 0.875rem;
        font-weight: 500;
    }

    .metadata-item .value.status-success {
        color: var(--success);
        font-weight: 600;
    }

    .metadata-item .value.status-warning {
        color: var(--warning);
        font-weight: 600;
    }

    .metadata-item .value.status-error {
        color: var(--danger);
        font-weight: 600;
    }

    .metadata-item .value.status-failed {
        color: var(--danger);
        font-weight: 600;
    }

    .metadata-item .value.large {
        font-size: 1.125rem;
        font-weight: 700;
    }

    /* Status Banner */
    .status-banner {
        display: none;
        background: var(--bg-secondary);
        border: 2px solid;
        border-radius: 0.5rem;
        padding: 1.25rem 1.5rem;
        margin-bottom: 1rem;
        align-items: center;
        gap: 1rem;
    }

    .status-banner.visible {
        display: flex;
    }

    .status-banner.status-failed {
        background: rgba(239, 68, 68, 0.1);
        border-color: var(--danger);
    }

    .status-banner.status-completed {
        background: rgba(16, 185, 129, 0.1);
        border-color: var(--success);
    }

    .status-banner.status-warning {
        background: rgba(245, 158, 11, 0.1);
        border-color: var(--warning);
    }

    .status-banner.status-processing {
        background: rgba(59, 130, 246, 0.1);
        border-color: #3b82f6;
    }

    .status-icon {
        font-size: 2rem;
        line-height: 1;
        flex-shrink: 0;
    }

    .status-failed .status-icon {
        color: var(--danger);
    }

    .status-completed .status-icon {
        color: var(--success);
    }

    .status-warning .status-icon {
        color: var(--warning);
    }

    .status-processing .status-icon {
        color: #3b82f6;
    }

    .status-content {
        flex: 1;
    }

    .status-content h3 {
        font-size: 1.125rem;
        font-weight: 700;
        margin: 0 0 0.25rem 0;
        color: var(--text-primary);
    }

    .status-content p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.875rem;
        line-height: 1.5;
    }

    .status-failed .status-content h3 {
        color: var(--danger);
    }

    .status-completed .status-content h3 {
        color: var(--success);
    }

    .status-warning .status-content h3 {
        color: var(--warning);
    }

    .status-processing .status-content h3 {
        color: #3b82f6;
    }

    .status-metrics {
        display: flex;
        gap: 1.5rem;
        margin-top: 0.5rem;
        flex-wrap: wrap;
    }

    .status-metric {
        display: flex;
        align-items: baseline;
        gap: 0.375rem;
    }

    .status-metric-value {
        font-size: 1.25rem;
        font-weight: 700;
    }

    .status-metric-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 600;
        color: var(--text-secondary);
    }

    .status-failed .status-metric-value.error-count {
        color: var(--danger);
    }

    .status-completed .status-metric-value {
        color: var(--success);
    }

    .status-warning .status-metric-value.warning-count {
        color: var(--warning);
    }
</style>

    /* Validation Results Styling */
    .validation-results {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .validation-rule {
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 0.375rem;
        padding: 0.75rem 1rem;
        transition: all 0.2s ease;
    }

    .validation-rule:hover {
        border-color: var(--border-light);
    }

    .validation-rule-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
        user-select: none;
    }

    .validation-icon {
        font-size: 1.25rem;
        font-weight: bold;
        width: 1.5rem;
        text-align: center;
    }

    .validation-icon.pass {
        color: var(--success);
    }

    .validation-icon.fail {
        color: var(--danger);
    }

    .validation-icon.warning {
        color: var(--warning);
    }

    .validation-rule-name {
        flex: 1;
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.875rem;
    }

    .validation-rule.failed {
        background: rgba(239, 68, 68, 0.1);
        border-color: var(--danger);
    }

    .validation-rule.failed .validation-rule-name {
        color: var(--danger);
    }

    .validation-badge {
        background: var(--bg-secondary);
        color: var(--text-secondary);
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .validation-badge.critical {
        background: var(--danger);
        color: white;
    }

    .validation-badge.warning {
        background: var(--warning);
        color: white;
    }

    .validation-details {
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid var(--border);
        display: none;
    }

    .validation-details.expanded {
        display: block;
    }

    .validation-error-item {
        background: var(--bg-secondary);
        padding: 0.5rem 0.75rem;
        border-radius: 0.25rem;
        margin-bottom: 0.5rem;
        font-size: 0.8125rem;
        border-left: 3px solid var(--danger);
    }

    .validation-error-item:last-child {
        margin-bottom: 0;
    }

    .validation-error-item.warning {
        border-left-color: var(--warning);
    }

    .validation-error-meta {
        color: var(--text-secondary);
        font-size: 0.75rem;
        margin-bottom: 0.25rem;
    }

    .validation-error-message {
        color: var(--text-primary);
        font-weight: 500;
    }

    .validation-summary-header {
        background: var(--bg-tertiary);
        padding: 1rem;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
        border: 1px solid var(--border);
    }

    .validation-summary-header h4 {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0 0 0.75rem 0;
    }

    .validation-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
        font-size: 0.8125rem;
    }

    .validation-stat {
        display: flex;
        justify-content: space-between;
        color: var(--text-secondary);
    }

    .validation-stat strong {
        color: var(--text-primary);
    }

    .validation-stat.failed strong {
        color: var(--danger);
    }

    .validation-stat.passed strong {
        color: var(--success);
    }
{% endblock %}

{% block content %}
<h2>Debug Interface</h2>

<!-- File Navigation -->
<div class="file-nav">
    <button class="nav-btn" id="prev-btn" onclick="navigateFile('prev')" disabled>← Previous</button>
    <select class="file-select" id="file-select" onchange="loadFile()">
        <option value="">Loading files...</option>
    </select>
    <button class="nav-btn" id="next-btn" onclick="navigateFile('next')" disabled>Next →</button>
    <span id="file-position" style="margin-left: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">File 0 of 0</span>
    <button class="nav-btn" id="delete-btn" onclick="confirmDeleteFile()" disabled style="margin-left: auto; background: var(--danger); color: white; border-color: var(--danger);">Delete File</button>
</div>

<!-- File Metadata Section -->
<div class="file-metadata" id="file-metadata">
    <h3>File Information</h3>
    <div class="metadata-grid">
        <div class="metadata-item">
            <label>Uploaded</label>
            <div class="value" id="meta-uploaded">-</div>
        </div>
        <div class="metadata-item">
            <label>File Name</label>
            <div class="value" id="meta-filename">-</div>
        </div>
        <div class="metadata-item">
            <label>File Size</label>
            <div class="value" id="meta-filesize">-</div>
        </div>
        <div class="metadata-item">
            <label>Umbrella</label>
            <div class="value" id="meta-umbrella">-</div>
        </div>
        <div class="metadata-item">
            <label>Period</label>
            <div class="value" id="meta-period">-</div>
        </div>
        <div class="metadata-item">
            <label>Status</label>
            <div class="value" id="meta-status">-</div>
        </div>
        <div class="metadata-item">
            <label>Total Rows</label>
            <div class="value large" id="meta-total-rows">-</div>
        </div>
        <div class="metadata-item">
            <label>Records Imported</label>
            <div class="value large" id="meta-imported">-</div>
        </div>
        <div class="metadata-item">
            <label>Errors</label>
            <div class="value large" id="meta-errors">-</div>
        </div>
        <div class="metadata-item">
            <label>Warnings</label>
            <div class="value large" id="meta-warnings">-</div>
        </div>
    </div>
</div>

<!-- Status Banner -->
<div class="status-banner" id="status-banner">
    <div class="status-icon" id="status-icon">-</div>
    <div class="status-content">
        <h3 id="status-title">File Status</h3>
        <p id="status-summary">Select a file to view status</p>
        <div class="status-metrics" id="status-metrics"></div>
    </div>
</div>

<!-- Three-Panel Layout -->
<div class="debug-container">
    <!-- Panel 1: Excel File Viewer -->
    <div class="debug-panel">
        <div class="panel-header">
            <h3>Panel 1: Excel File</h3>
            <span class="info-badge" id="excel-badge">No file selected</span>
        </div>
        <div class="panel-content" id="excel-panel">
            <div class="empty-state">
                <h4>No File Selected</h4>
                <p>Select a file from the dropdown above to view its contents</p>
            </div>
        </div>
    </div>

    <!-- Panel 2: Database Records -->
    <div class="debug-panel">
        <div class="panel-header">
            <h3>Panel 2: Database Records</h3>
            <span class="info-badge" id="db-badge">0 records</span>
        </div>
        <div class="panel-content" id="db-panel">
            <div class="empty-state">
                <h4>No Records</h4>
                <p>Database records will appear here when a file is selected</p>
            </div>
        </div>
    </div>

    <!-- Panel 3: Comparison & Analysis -->
    <div class="debug-panel">
        <div class="panel-header">
            <h3>Panel 3: Comparison</h3>
            <span class="info-badge" id="comp-badge">Ready</span>
        </div>
        <div class="panel-content" id="comparison-panel">
            <div class="empty-state">
                <h4>Ready to Compare</h4>
                <p>Comparison results will appear here</p>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="delete-modal">
    <div class="modal-content">
        <h3>Delete File?</h3>
        <p>Are you sure you want to delete this file? This action cannot be undone.</p>

        <dl class="file-details" id="modal-file-details">
            <dt>File Name</dt>
            <dd id="modal-filename">-</dd>

            <dt>Umbrella Company</dt>
            <dd id="modal-umbrella">-</dd>

            <dt>Status</dt>
            <dd id="modal-status">-</dd>
        </dl>

        <p style="color: var(--danger); font-weight: 500;">This will delete:</p>
        <ul style="color: var(--text-secondary); font-size: 0.875rem; margin: 0.5rem 0 1.5rem 1.5rem;">
            <li>S3 file from bucket</li>
            <li>File metadata record</li>
            <li>All PayRecord entries</li>
            <li>All ValidationError records</li>
            <li>All ValidationWarning records</li>
        </ul>

        <div class="modal-actions">
            <button class="modal-btn modal-btn-cancel" onclick="closeDeleteModal()">Cancel</button>
            <button class="modal-btn modal-btn-delete" onclick="deleteCurrentFile()">Delete File</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SheetJS Library -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<script>
    let allFiles = [];
    let currentFileIndex = -1;
    let currentWorkbook = null;
    let currentSheetName = null;
    let abortController = null;  // For canceling in-progress requests
    let isLoading = false;        // Prevent concurrent loads

    // Load files on page load
    window.addEventListener('DOMContentLoaded', () => {
        loadFilesList();
    });

    async function loadFilesList() {
        try {
            const response = await fetch('/api/debug/files');
            const data = await response.json();

            allFiles = data.files || [];

            const select = document.getElementById('file-select');
            select.innerHTML = '<option value="">Select a file...</option>';

            allFiles.forEach((file, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${file.filename} (${file.umbrella}) - ${file.status}`;
                select.appendChild(option);
            });

            updateNavigationButtons();
        } catch (error) {
            console.error('Failed to load files:', error);
            document.getElementById('file-select').innerHTML = '<option value="">Error loading files</option>';
        }
    }

    async function loadFile() {
        // Prevent concurrent loads
        if (isLoading) {
            console.log('Load already in progress, skipping...');
            return;
        }

        const select = document.getElementById('file-select');
        if (!select) {
            console.error('File select element not found');
            return;
        }

        const index = parseInt(select.value);
        if (isNaN(index) || index < 0 || index >= allFiles.length) {
            console.log('Invalid file index:', index);
            return;
        }

        // Cancel any in-progress requests
        if (abortController) {
            abortController.abort();
        }
        abortController = new AbortController();

        // Set loading state
        isLoading = true;

        try {
            currentFileIndex = index;
            const file = allFiles[index];

            if (!file || !file.file_id) {
                throw new Error('Invalid file object');
            }

            // Update navigation buttons
            updateNavigationButtons();

            // Update file metadata (synchronous, safe)
            try {
                updateFileMetadata(file);
            } catch (error) {
                console.error('Error updating metadata:', error);
            }

            // Update status banner (synchronous, safe)
            try {
                updateStatusBanner(file);
            } catch (error) {
                console.error('Error updating status banner:', error);
            }

            // Load Excel file and database records in parallel
            await Promise.allSettled([
                loadExcelFile(file, abortController.signal),
                loadDatabaseRecords(file, abortController.signal)
            ]);

        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('File load was cancelled');
            } else {
                console.error('Error loading file:', error);
            }
        } finally {
            isLoading = false;
        }
    }

    function updateFileMetadata(file) {
        const metadataSection = document.getElementById('file-metadata');
        metadataSection.classList.add('visible');

        // Format uploaded date
        const uploadedDate = file.uploaded_at ? new Date(file.uploaded_at).toLocaleString('en-US', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        }) : 'Unknown';

        // Format file size
        const formatBytes = (bytes) => {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        };

        // Update metadata fields
        document.getElementById('meta-uploaded').textContent = uploadedDate;
        document.getElementById('meta-filename').textContent = file.filename || 'Unknown';
        document.getElementById('meta-filesize').textContent = formatBytes(file.file_size || 0);
        document.getElementById('meta-umbrella').textContent = file.umbrella || 'Unknown';
        document.getElementById('meta-period').textContent = file.period_id || 'Unknown';

        // Update status with color coding
        const statusElem = document.getElementById('meta-status');
        statusElem.textContent = file.status || 'UNKNOWN';
        statusElem.className = 'value';
        if (file.status === 'COMPLETED') {
            statusElem.classList.add('status-success');
        } else if (file.status === 'FAILED' || file.status === 'ERROR') {
            statusElem.classList.add('status-failed');
        } else if (file.status === 'WARNING') {
            statusElem.classList.add('status-warning');
        }

        // Update numeric fields with color coding
        document.getElementById('meta-total-rows').textContent = file.total_records || 0;

        const importedElem = document.getElementById('meta-imported');
        importedElem.textContent = file.valid_records || 0;
        if (file.valid_records > 0) {
            importedElem.classList.add('status-success');
        }

        const errorsElem = document.getElementById('meta-errors');
        errorsElem.textContent = file.error_count || 0;
        if (file.error_count > 0) {
            errorsElem.classList.add('status-error');
        }

        const warningsElem = document.getElementById('meta-warnings');
        warningsElem.textContent = file.warning_count || 0;
        if (file.warning_count > 0) {
            warningsElem.classList.add('status-warning');
        }
    }

    function updateStatusBanner(file) {
        const banner = document.getElementById('status-banner');
        const icon = document.getElementById('status-icon');
        const title = document.getElementById('status-title');
        const summary = document.getElementById('status-summary');
        const metrics = document.getElementById('status-metrics');

        // Show banner
        banner.classList.add('visible');

        // Clear previous status classes
        banner.className = 'status-banner visible';

        // Update based on status
        const status = file.status || 'UNKNOWN';
        let statusClass = 'status-processing';
        let iconText = '⏳';
        let titleText = 'Processing';
        let summaryText = 'File is being processed...';

        if (status === 'COMPLETED') {
            statusClass = 'status-completed';
            iconText = '✓';
            titleText = 'Processing Complete';
            summaryText = 'All records have been successfully imported.';
        } else if (status === 'FAILED' || status === 'ERROR') {
            statusClass = 'status-failed';
            iconText = '✗';
            titleText = 'Processing Failed';
            summaryText = file.error_message || 'File processing encountered errors.';
        } else if (status === 'WARNING') {
            statusClass = 'status-warning';
            iconText = '⚠';
            titleText = 'Completed with Warnings';
            summaryText = 'File processed but some warnings were detected.';
        }

        banner.classList.add(statusClass);
        icon.textContent = iconText;
        title.textContent = titleText;
        summary.textContent = summaryText;

        // Update metrics
        let metricsHtml = '';
        if (file.total_records) {
            metricsHtml += `<div class="status-metric"><span class="status-metric-label">Total Records:</span><span class="status-metric-value">${file.total_records}</span></div>`;
        }
        if (file.valid_records) {
            metricsHtml += `<div class="status-metric"><span class="status-metric-label">Imported:</span><span class="status-metric-value">${file.valid_records}</span></div>`;
        }
        if (file.error_count) {
            metricsHtml += `<div class="status-metric"><span class="status-metric-label">Errors:</span><span class="status-metric-value error-count">${file.error_count}</span></div>`;
        }
        if (file.warning_count) {
            metricsHtml += `<div class="status-metric"><span class="status-metric-label">Warnings:</span><span class="status-metric-value warning-count">${file.warning_count}</span></div>`;
        }
        metrics.innerHTML = metricsHtml;
    }


    async function updateStatusBanner(file) {
        const banner = document.getElementById('status-banner');
        const icon = document.getElementById('status-icon');
        const title = document.getElementById('status-title');
        const summary = document.getElementById('status-summary');
        const metrics = document.getElementById('status-metrics');

        // Remove all status classes
        banner.classList.remove('status-failed', 'status-completed', 'status-warning', 'status-processing');

        try {
            // Fetch validation details
            const response = await fetch(`/api/files/${file.file_id}/validation`);
            const data = await response.json();

            const errors = data.errors || [];
            const warnings = data.warnings || [];
            const records = data.records_imported || 0;
            const status = file.status.toUpperCase();

            // Set status-specific styling and content
            let statusClass = '';
            let statusIcon = '';
            let statusTitle = '';
            let statusSummary = '';

            if (status === 'FAILED') {
                statusClass = 'status-failed';
                statusIcon = '✗';
                statusTitle = 'File Validation FAILED';

                // Build error summary
                const errorMessages = [];
                if (errors.length > 0) {
                    // Count contractor not found errors
                    const contractorNotFound = errors.filter(e =>
                        e.message && e.message.toLowerCase().includes('contractor') &&
                        e.message.toLowerCase().includes('not found')
                    ).length;

                    if (contractorNotFound > 0) {
                        errorMessages.push(`${contractorNotFound} contractor${contractorNotFound > 1 ? 's' : ''} not found in database`);
                    }

                    // Count other errors
                    const otherErrors = errors.length - contractorNotFound;
                    if (otherErrors > 0) {
                        errorMessages.push(`${otherErrors} other error${otherErrors > 1 ? 's' : ''}`);
                    }
                }

                statusSummary = errorMessages.length > 0
                    ? `${errorMessages.join(' | ')} | ${records} records imported | See Panel 3 for details`
                    : `${errors.length} errors found | ${records} records imported | See Panel 3 for details`;

            } else if (status === 'COMPLETED') {
                statusClass = 'status-completed';
                statusIcon = '✓';
                statusTitle = 'File Validation COMPLETED';
                statusSummary = `All validations passed | ${records} records imported successfully`;

            } else if (warnings.length > 0) {
                statusClass = 'status-warning';
                statusIcon = '⚠';
                statusTitle = 'File Validation COMPLETED with Warnings';
                statusSummary = `${warnings.length} warning${warnings.length > 1 ? 's' : ''} found | ${records} records imported | See Panel 3 for details`;

            } else if (status === 'PROCESSING') {
                statusClass = 'status-processing';
                statusIcon = '⟳';
                statusTitle = 'File PROCESSING';
                statusSummary = 'File is currently being processed...';

            } else {
                statusClass = 'status-processing';
                statusIcon = '○';
                statusTitle = `File Status: ${status}`;
                statusSummary = `Current status: ${status}`;
            }

            // Apply styling
            banner.classList.add(statusClass, 'visible');
            icon.textContent = statusIcon;
            title.textContent = statusTitle;
            summary.textContent = statusSummary;

            // Build metrics
            let metricsHTML = '';
            if (status === 'FAILED' || status === 'COMPLETED' || warnings.length > 0) {
                if (errors.length > 0) {
                    metricsHTML += `
                        <div class="status-metric">
                            <span class="status-metric-value error-count">${errors.length}</span>
                            <span class="status-metric-label">Errors</span>
                        </div>
                    `;
                }
                if (warnings.length > 0) {
                    metricsHTML += `
                        <div class="status-metric">
                            <span class="status-metric-value warning-count">${warnings.length}</span>
                            <span class="status-metric-label">Warnings</span>
                        </div>
                    `;
                }
                metricsHTML += `
                    <div class="status-metric">
                        <span class="status-metric-value">${records}</span>
                        <span class="status-metric-label">Records Imported</span>
                    </div>
                `;
            }
            metrics.innerHTML = metricsHTML;

        } catch (error) {
            console.error('Error fetching validation details:', error);
            // Show basic status from file metadata
            banner.classList.add('visible');
            icon.textContent = '○';
            title.textContent = `File Status: ${file.status}`;
            summary.textContent = 'Unable to load detailed validation information';
            metrics.innerHTML = '';
        }
    }

    async function loadExcelFile(file, signal) {
        const panel = document.getElementById('excel-panel');
        const badge = document.getElementById('excel-badge');

        if (!panel || !badge) {
            console.error('Excel panel elements not found');
            return;
        }

        panel.innerHTML = '<div class="loading">Loading Excel file...</div>';
        badge.textContent = 'Loading...';

        try {
            if (!file || !file.file_id) {
                throw new Error('Invalid file object');
            }

            // Fetch file from S3 with abort signal
            const response = await fetch(`/api/files/${file.file_id}/download`, { signal });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: Failed to download file`);
            }

            const arrayBuffer = await response.arrayBuffer();

            // Check if request was aborted
            if (signal && signal.aborted) {
                return;
            }

            // Parse with SheetJS
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            currentWorkbook = workbook;

            if (!workbook || !workbook.SheetNames || workbook.SheetNames.length === 0) {
                throw new Error('Invalid workbook: No sheets found');
            }

            // Get first sheet by default
            const sheetName = workbook.SheetNames[0];
            currentSheetName = sheetName;

            // Display workbook
            displayExcelSheet(workbook, sheetName);

            badge.textContent = `${workbook.SheetNames.length} sheet${workbook.SheetNames.length > 1 ? 's' : ''}`;
        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('Excel file load was cancelled');
                return;
            }
            console.error('Error loading Excel file:', error);
            if (panel) {
                panel.innerHTML = `<div class="empty-state"><h4>Error Loading Excel</h4><p>${escapeHtml(error.message)}</p></div>`;
            }
            if (badge) {
                badge.textContent = 'Error';
            }
        }
    }

    function displayExcelSheet(workbook, sheetName) {
        const panel = document.getElementById('excel-panel');
        const badge = document.getElementById('excel-badge');

        if (!panel || !badge) {
            console.error('Excel panel elements not found');
            return;
        }

        if (!workbook || !workbook.Sheets || !workbook.SheetNames) {
            console.error('Invalid workbook');
            panel.innerHTML = '<div class="empty-state"><h4>Error</h4><p>Invalid workbook data</p></div>';
            return;
        }

        try {
            // Create sheet tabs if multiple sheets
            let html = '';
            if (workbook.SheetNames.length > 1) {
                html += '<div class="sheet-tabs">';
                workbook.SheetNames.forEach(name => {
                    const activeClass = name === sheetName ? 'active' : '';
                    const escapedName = escapeHtml(name).replace(/'/g, '&#39;');
                    html += `<div class="sheet-tab ${activeClass}" onclick="switchSheet('${escapedName}')">${escapeHtml(name)}</div>`;
                });
                html += '</div>';
            }

            // Get sheet data
            const worksheet = workbook.Sheets[sheetName];
            if (!worksheet) {
                throw new Error(`Sheet "${sheetName}" not found`);
            }

            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

            // Filter out empty rows - only keep rows with at least one non-empty cell
            const filteredData = jsonData.filter(row =>
                row && row.some && row.some(cell => cell !== null && cell !== undefined && cell !== '')
            );

            // Update badge with accurate row count
            const dataRowCount = filteredData.length > 0 ? filteredData.length - 1 : 0; // Exclude header row
            badge.textContent = `${dataRowCount} row${dataRowCount !== 1 ? 's' : ''}`;

            // Create table
            html += '<div class="excel-container">';
            html += '<table class="excel-table">';

            // Add header row
            if (filteredData.length > 0) {
                html += '<thead><tr>';
                (filteredData[0] || []).forEach(cell => {
                    html += `<th>${escapeHtml(String(cell || ''))}</th>`;
                });
                html += '</tr></thead>';

                // Add data rows
                html += '<tbody>';
                for (let i = 1; i < filteredData.length; i++) {
                    html += '<tr>';
                    (filteredData[i] || []).forEach(cell => {
                        html += `<td>${escapeHtml(String(cell || ''))}</td>`;
                    });
                    html += '</tr>';
                }
                html += '</tbody>';
            }

            html += '</table></div>';

            panel.innerHTML = html;
        } catch (error) {
            console.error('Error displaying Excel sheet:', error);
            panel.innerHTML = `<div class="empty-state"><h4>Error</h4><p>${escapeHtml(error.message)}</p></div>`;
            badge.textContent = 'Error';
        }
    }

    function switchSheet(sheetName) {
        currentSheetName = sheetName;
        displayExcelSheet(currentWorkbook, sheetName);
    }

    async function loadDatabaseRecords(file, signal) {
        const panel = document.getElementById('db-panel');
        const badge = document.getElementById('db-badge');

        if (!panel || !badge) {
            console.error('Database panel elements not found');
            return;
        }

        panel.innerHTML = '<div class="loading">Loading database records...</div>';
        badge.textContent = 'Loading...';

        try {
            if (!file || !file.file_id) {
                throw new Error('Invalid file object');
            }

            // Fetch with abort signal
            const response = await fetch(`/api/files/${file.file_id}/database`, { signal });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: Failed to load database records`);
            }

            const data = await response.json();

            // Check if request was aborted
            if (signal && signal.aborted) {
                return;
            }

            const records = data.pay_records || [];
            const errors = data.validation_errors || [];
            const warnings = data.validation_warnings || [];
            const fileStatus = data.file_metadata?.Status || file.status;

            // Update badge
            if (records.length > 0) {
                badge.textContent = `${records.length} record${records.length > 1 ? 's' : ''}`;
            } else if (errors.length > 0) {
                badge.textContent = `${errors.length} error${errors.length > 1 ? 's' : ''}`;
            } else {
                badge.textContent = '0 records';
            }

            // If file FAILED or has ERROR status and no PayRecords, show validation errors
            if ((fileStatus === 'FAILED' || fileStatus === 'ERROR') && records.length === 0) {
                displayValidationErrors(errors, warnings, fileStatus);
                return;
            }

            // If we have records, display them normally
            if (records.length === 0) {
                panel.innerHTML = '<div class="empty-state"><h4>No Records</h4><p>No database records found for this file</p></div>';
                return;
            }

            // Display records in table
            displayDatabaseRecords(records);

            // Load validation results for Panel 3 with signal
            loadValidationResults(file, signal);
        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('Database records load was cancelled');
                return;
            }
            console.error('Error loading database records:', error);
            if (panel) {
                panel.innerHTML = `<div class="empty-state"><h4>Error Loading Records</h4><p>${escapeHtml(error.message)}</p></div>`;
            }
            if (badge) {
                badge.textContent = 'Error';
            }
        }
    }


    function displayValidationErrors(errors, warnings, fileStatus) {
        const panel = document.getElementById('db-panel');

        let html = '<div style="padding: 1rem;">';

        // Header
        html += '<div style="background: rgba(239, 68, 68, 0.1); border: 2px solid var(--danger); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">';
        html += '<h4 style="color: var(--danger); margin: 0 0 0.5rem 0; font-size: 1rem; font-weight: 700;">Validation Failed</h4>';
        html += `<p style="color: var(--text-primary); margin: 0; font-size: 0.875rem;">This file has status <strong>${fileStatus}</strong> and no PayRecords were created due to validation errors.</p>`;
        html += '</div>';

        // Validation Errors Section
        if (errors.length > 0) {
            html += '<div style="margin-bottom: 1.5rem;">';
            html += `<h4 style="color: var(--danger); margin-bottom: 0.75rem; font-size: 0.875rem; font-weight: 600;">Validation Errors (${errors.length})</h4>`;

            // Group errors by type
            const errorsByType = {};
            errors.forEach(error => {
                const errorType = error.ErrorType || 'UNKNOWN';
                if (!errorsByType[errorType]) {
                    errorsByType[errorType] = [];
                }
                errorsByType[errorType].push(error);
            });

            // Display each error type
            Object.keys(errorsByType).forEach(errorType => {
                const errorList = errorsByType[errorType];
                const readableType = errorType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

                html += '<div style="background: var(--bg-tertiary); border: 1px solid var(--danger); border-radius: 0.375rem; padding: 0.75rem; margin-bottom: 0.75rem;">';
                html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">`;
                html += `<strong style="color: var(--danger); font-size: 0.8rem;">${readableType}</strong>`;
                html += `<span style="background: var(--danger); color: white; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.65rem; font-weight: 600;">${errorList.length} error${errorList.length > 1 ? 's' : ''}</span>`;
                html += '</div>';

                // List individual errors
                html += '<div style="font-size: 0.75rem;">';
                errorList.forEach(error => {
                    html += '<div style="padding: 0.5rem; background: var(--bg-secondary); border-radius: 0.25rem; margin-bottom: 0.5rem; border-left: 3px solid var(--danger);">';

                    if (error.RowNumber) {
                        html += `<div style="color: var(--text-secondary); font-weight: 600; margin-bottom: 0.25rem;">Row ${error.RowNumber}</div>`;
                    }

                    if (error.EmployeeID) {
                        html += `<div style="color: var(--text-secondary); margin-bottom: 0.25rem;">Employee: ${escapeHtml(error.EmployeeID)}</div>`;
                    }

                    html += `<div style="color: var(--text-primary);">${escapeHtml(error.ErrorMessage || 'No error message available')}</div>`;

                    if (error.Severity) {
                        html += `<div style="color: var(--text-secondary); font-size: 0.7rem; margin-top: 0.25rem;">Severity: ${error.Severity}</div>`;
                    }

                    html += '</div>';
                });
                html += '</div>';
                html += '</div>';
            });

            html += '</div>';
        }

        // Validation Warnings Section
        if (warnings.length > 0) {
            html += '<div>';
            html += `<h4 style="color: var(--warning); margin-bottom: 0.75rem; font-size: 0.875rem; font-weight: 600;">Validation Warnings (${warnings.length})</h4>`;

            warnings.forEach(warning => {
                html += '<div style="background: var(--bg-tertiary); border: 1px solid var(--warning); border-radius: 0.375rem; padding: 0.75rem; margin-bottom: 0.5rem; border-left: 3px solid var(--warning);">';

                if (warning.RowNumber) {
                    html += `<div style="color: var(--text-secondary); font-weight: 600; font-size: 0.75rem; margin-bottom: 0.25rem;">Row ${warning.RowNumber}</div>`;
                }

                html += `<div style="color: var(--text-primary); font-size: 0.8rem;">${escapeHtml(warning.WarningMessage || 'No warning message available')}</div>`;

                if (warning.AutoResolved) {
                    html += '<div style="color: var(--success); font-size: 0.7rem; margin-top: 0.25rem;">Auto-resolved</div>';
                }

                html += '</div>';
            });

            html += '</div>';
        }

        // No errors or warnings
        if (errors.length === 0 && warnings.length === 0) {
            html += '<div class="empty-state" style="padding: 2rem;">';
            html += '<h4 style="color: var(--text-primary);">No Validation Details Available</h4>';
            html += '<p style="color: var(--text-secondary);">File status is ' + fileStatus + ' but no validation errors or warnings were found in the database.</p>';
            html += '</div>';
        }

        html += '</div>';
        panel.innerHTML = html;
    }

    async function loadValidationResults(file, signal) {
        const panel = document.getElementById('comparison-panel');
        const badge = document.getElementById('comp-badge');

        if (!panel || !badge) {
            console.error('Comparison panel elements not found');
            return;
        }

        panel.innerHTML = '<div class="loading">Loading validation results...</div>';
        badge.textContent = 'Loading...';

        try {
            if (!file || !file.file_id) {
                throw new Error('Invalid file object');
            }

            // Fetch with abort signal
            const response = await fetch(`/api/files/${file.file_id}/validation`, { signal });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: Failed to load validation results`);
            }

            const data = await response.json();

            // Check if request was aborted
            if (signal && signal.aborted) {
                return;
            }

            if (data.error) {
                throw new Error(data.message || 'Failed to load validation results');
            }

            // Display validation results
            displayValidationResults(data);

        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('Validation results load was cancelled');
                return;
            }
            console.error('Error loading validation results:', error);
            if (panel) {
                panel.innerHTML = `<div class="empty-state"><h4>Error Loading Validation</h4><p>${escapeHtml(error.message)}</p></div>`;
            }
            if (badge) {
                badge.textContent = 'Error';
            }
        }
    }

    function displayValidationResults(data) {
        const panel = document.getElementById('comparison-panel');
        const badge = document.getElementById('comp-badge');
        const validationRules = data.validation_rules || [];
        const snapshot = data.snapshot;

        if (!panel || !badge) {
            console.error('Comparison panel elements not found');
            return;
        }

        let html = '';
        let totalErrors = 0;
        let totalWarnings = 0;

        // Count errors and warnings
        validationRules.forEach(rule => {
            if (!rule.passed) {
                if (rule.is_warning || rule.severity === 'WARNING') {
                    totalWarnings++;
                } else {
                    totalErrors++;
                }
            }
        });

        // Update badge
        const status = snapshot?.status || 'UNKNOWN';
        if (status === 'FAILED' || status === 'ERROR') {
            badge.textContent = `${totalErrors} error${totalErrors !== 1 ? 's' : ''}`;
            badge.style.background = 'var(--danger)';
            badge.style.color = 'white';
        } else if (status === 'COMPLETED' || status === 'SUCCESS') {
            badge.textContent = 'All checks passed';
            badge.style.background = 'var(--success)';
            badge.style.color = 'white';
        } else {
            badge.textContent = status;
        }

        // Validation Status Header (like your screenshot)
        const headerBg = status === 'FAILED' ? 'rgba(239, 68, 68, 0.1)' : 'rgba(34, 197, 94, 0.1)';
        const headerBorder = status === 'FAILED' ? 'var(--danger)' : 'var(--success)';
        const headerColor = status === 'FAILED' ? 'var(--danger)' : 'var(--success)';
        const statusIcon = status === 'FAILED' ? '✗' : '✓';

        html += `<div style="background: ${headerBg}; border: 2px solid ${headerBorder}; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem;">`;
        html += `<h3 style="color: ${headerColor}; margin: 0; font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">`;
        html += `<span style="font-size: 1.5rem;">${statusIcon}</span> Validation: ${status}`;
        html += `</h3>`;
        if (totalErrors > 0 || totalWarnings > 0) {
            html += `<p style="margin: 0.5rem 0 0 0; color: var(--text-secondary);">`;
            html += `VALIDATION FAILED for records: ${totalErrors} error(s), ${totalWarnings} warning(s)`;
            html += `</p>`;
        }
        html += `</div>`;

        // Validation Rules
        if (validationRules.length === 0) {
            html += '<div class="empty-state"><h4>No Validation Data</h4><p>No validation results found for this file</p></div>';
        } else {
            // Create detailed table like your screenshot
            html += '<div style="margin-bottom: 1.5rem;">';
            html += '<table style="width: 100%; border-collapse: collapse; background: var(--bg-secondary); border-radius: 0.5rem; overflow: hidden;">';
            html += '<thead><tr style="background: var(--bg-tertiary);">';
            html += '<th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border); font-weight: 600;">Type</th>';
            html += '<th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border); font-weight: 600;">Item</th>';
            html += '<th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border); font-weight: 600;">Calculated</th>';
            html += '<th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border); font-weight: 600;">Expected</th>';
            html += '<th style="padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--border); font-weight: 600; width: 50px;">✓</th>';
            html += '</tr></thead><tbody>';

            validationRules.forEach((rule, index) => {
                const passed = rule.passed;
                const isWarning = rule.is_warning || rule.severity === 'WARNING';
                const rowBg = !passed ? 'rgba(239, 68, 68, 0.05)' : 'transparent';
                const icon = passed ? '<span style="color: var(--success); font-size: 1.25rem;">✓</span>' : '<span style="color: var(--danger); font-size: 1.25rem;">✗</span>';

                // Extract type and item from rule name
                const ruleName = rule.name || 'Unknown';
                let ruleType = 'Validation';
                let ruleItem = ruleName;

                // Try to parse rule name for better display
                if (ruleName.includes(':')) {
                    const parts = ruleName.split(':');
                    ruleType = parts[0].trim();
                    ruleItem = parts[1]?.trim() || ruleType;
                }

                // Get values from error messages if available
                let calculated = '-';
                let expected = '-';

                if (rule.errors && rule.errors.length > 0) {
                    const firstError = rule.errors[0];
                    calculated = firstError.actual_value || firstError.calculated || '-';
                    expected = firstError.expected_value || firstError.expected || '-';
                } else if (rule.messages && rule.messages.length > 0) {
                    // Try to parse from message
                    const msg = rule.messages[0];
                    const calcMatch = msg.match(/calculated:?\s*([^\s,]+)/i) || msg.match(/actual:?\s*([^\s,]+)/i);
                    const expMatch = msg.match(/expected:?\s*([^\s,]+)/i);
                    if (calcMatch) calculated = calcMatch[1];
                    if (expMatch) expected = expMatch[1];
                }

                html += `<tr style="background: ${rowBg}; border-bottom: 1px solid var(--border);">`;
                html += `<td style="padding: 0.75rem;">${escapeHtml(ruleType)}</td>`;
                html += `<td style="padding: 0.75rem;">${escapeHtml(ruleItem)}</td>`;
                html += `<td style="padding: 0.75rem;">${escapeHtml(String(calculated))}</td>`;
                html += `<td style="padding: 0.75rem;">${escapeHtml(String(expected))}</td>`;
                html += `<td style="padding: 0.75rem; text-align: center;">${icon}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';

            // Collect all error messages
            const allErrors = [];
            validationRules.forEach(rule => {
                if (!rule.passed) {
                    if (rule.errors && rule.errors.length > 0) {
                        rule.errors.forEach(error => {
                            allErrors.push(error.message || rule.name);
                        });
                    } else if (rule.messages && rule.messages.length > 0) {
                        allErrors.push(...rule.messages);
                    } else {
                        allErrors.push(rule.name);
                    }
                }
            });

            // Display error messages like your screenshot
            if (allErrors.length > 0) {
                html += '<div style="background: rgba(239, 68, 68, 0.1); border: 2px solid var(--danger); border-radius: 0.5rem; padding: 1rem;">';
                html += '<h4 style="color: var(--danger); margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">';
                html += '<span style="font-size: 1.25rem;">✗</span> Validation Errors:';
                html += '</h4>';
                html += '<ul style="margin: 0; padding-left: 1.5rem; color: var(--text-primary);">';
                allErrors.forEach(error => {
                    html += `<li style="margin-bottom: 0.5rem; display: flex; align-items: flex-start; gap: 0.5rem;">`;
                    html += `<span style="color: var(--danger); font-weight: bold;">✗</span>`;
                    html += `<span>${escapeHtml(error)}</span>`;
                    html += `</li>`;
                });
                html += '</ul>';
                html += '</div>';
            }
        }

        panel.innerHTML = html;
    }

    function toggleRuleDetails(index) {
        const details = document.getElementById(`details-${index}`);
        if (details) {
            details.classList.toggle('expanded');
        }
    }

    function displayDatabaseRecords(records) {
        const panel = document.getElementById('db-panel');

        if (records.length === 0) {
            panel.innerHTML = '<div class="empty-state"><h4>No Records</h4><p>No records found</p></div>';
            return;
        }

        // Get all unique keys
        const keys = [...new Set(records.flatMap(r => Object.keys(r)))];

        // Filter out internal keys for cleaner display
        const displayKeys = keys.filter(k => !k.startsWith('PK') && !k.startsWith('SK') && k !== 'EntityType');

        let html = '<div class="excel-container">';
        html += '<table class="db-table">';
        html += '<thead><tr>';
        displayKeys.forEach(key => {
            html += `<th>${escapeHtml(key)}</th>`;
        });
        html += '</tr></thead>';

        html += '<tbody>';
        records.forEach(record => {
            html += '<tr>';
            displayKeys.forEach(key => {
                const value = record[key] !== undefined ? record[key] : '';
                html += `<td>${escapeHtml(String(value))}</td>`;
            });
            html += '</tr>';
        });
        html += '</tbody></table></div>';

        panel.innerHTML = html;
    }

    function compareExcelWithDatabase(dbRecords) {
        const panel = document.getElementById('comparison-panel');

        // Get filtered Excel data (excluding empty rows)
        let excelRows = 0;
        if (currentWorkbook) {
            const jsonData = XLSX.utils.sheet_to_json(currentWorkbook.Sheets[currentSheetName], { header: 1, defval: '' });
            const filteredData = jsonData.filter(row =>
                row.some(cell => cell !== null && cell !== undefined && cell !== '')
            );
            excelRows = filteredData.length > 0 ? filteredData.length - 1 : 0; // Exclude header row
        }

        const dbRows = dbRecords.length;

        let html = '<div class="comparison-summary">';
        html += '<h4>Comparison Summary</h4>';
        html += '<div class="summary-grid">';
        html += `<div class="summary-item"><strong>Excel Rows</strong><span>${excelRows}</span></div>`;
        html += `<div class="summary-item"><strong>DB Records</strong><span>${dbRows}</span></div>`;

        const matchClass = excelRows === dbRows ? 'success' : 'warning';
        html += `<div class="summary-item ${matchClass}"><strong>Match</strong><span>${excelRows === dbRows ? 'Yes' : 'No'}</span></div>`;

        html += '</div></div>';

        html += '<div class="empty-state">';
        html += '<h4>Detailed Comparison</h4>';
        html += '<p>Detailed field-by-field comparison coming soon...</p>';
        html += '</div>';

        panel.innerHTML = html;
        document.getElementById('comp-badge').textContent = excelRows === dbRows ? 'Match' : 'Mismatch';
    }

    function navigateFile(direction) {
        if (direction === 'prev' && currentFileIndex > 0) {
            currentFileIndex--;
        } else if (direction === 'next' && currentFileIndex < allFiles.length - 1) {
            currentFileIndex++;
        }

        document.getElementById('file-select').value = currentFileIndex;
        loadFile();
    }

    function updateNavigationButtons() {
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const positionSpan = document.getElementById('file-position');

        prevBtn.disabled = currentFileIndex <= 0;
        nextBtn.disabled = currentFileIndex >= allFiles.length - 1 || allFiles.length === 0;
        deleteBtn.disabled = currentFileIndex < 0 || allFiles.length === 0;

        // Update position indicator
        if (currentFileIndex >= 0 && allFiles.length > 0) {
            positionSpan.textContent = `File ${currentFileIndex + 1} of ${allFiles.length}`;
        } else {
            positionSpan.textContent = `File 0 of ${allFiles.length}`;
        }
    }

    // Delete confirmation dialog
    function confirmDeleteFile() {
        if (currentFileIndex < 0 || currentFileIndex >= allFiles.length) {
            return;
        }

        const file = allFiles[currentFileIndex];

        // Populate modal with file details
        document.getElementById('modal-filename').textContent = file.filename || 'Unknown';
        document.getElementById('modal-umbrella').textContent = file.umbrella || 'Unknown';
        document.getElementById('modal-status').textContent = file.status || 'Unknown';

        // Show modal
        document.getElementById('delete-modal').classList.add('active');
    }

    function closeDeleteModal() {
        document.getElementById('delete-modal').classList.remove('active');
    }

    async function deleteCurrentFile() {
        if (currentFileIndex < 0 || currentFileIndex >= allFiles.length) {
            return;
        }

        const file = allFiles[currentFileIndex];
        const fileId = file.file_id;

        try {
            closeDeleteModal();

            // Show loading state
            document.getElementById('excel-panel').innerHTML = '<div class="loading">Deleting file...</div>';
            document.getElementById('db-panel').innerHTML = '<div class="loading">Deleting file...</div>';
            document.getElementById('comparison-panel').innerHTML = '<div class="loading">Deleting file...</div>';

            const response = await fetch(`/api/file/${fileId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Failed to delete file');
            }

            const result = await response.json();
            console.log('Delete successful:', result);

            // Remove file from list
            allFiles.splice(currentFileIndex, 1);

            // Update file select dropdown
            const select = document.getElementById('file-select');
            select.innerHTML = '<option value="">Select a file...</option>';
            allFiles.forEach((f, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${f.filename} (${f.umbrella}) - ${f.status}`;
                select.appendChild(option);
            });

            // Navigate to next file (or previous if at end)
            if (allFiles.length === 0) {
                currentFileIndex = -1;
                document.getElementById('excel-panel').innerHTML = '<div class="empty-state"><h4>No Files</h4><p>All files have been deleted</p></div>';
                document.getElementById('db-panel').innerHTML = '<div class="empty-state"><h4>No Files</h4></div>';
                document.getElementById('comparison-panel').innerHTML = '<div class="empty-state"><h4>No Files</h4></div>';
            } else {
                // Stay at same index if possible, otherwise go to previous
                if (currentFileIndex >= allFiles.length) {
                    currentFileIndex = allFiles.length - 1;
                }
                select.value = currentFileIndex;
                loadFile();
            }

            updateNavigationButtons();

            // Show success message
            alert(`File deleted successfully!\n\nDeleted:\n- S3 file\n- ${result.deleted?.items_deleted || 0} database records`);

        } catch (error) {
            console.error('Error deleting file:', error);
            alert('Failed to delete file: ' + error.message);
            // Reload the current file
            loadFile();
        }
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        // Don't trigger if user is typing in an input
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
            return;
        }

        // Arrow left = Previous
        if (e.key === 'ArrowLeft' && currentFileIndex > 0) {
            e.preventDefault();
            navigateFile('prev');
        }

        // Arrow right = Next
        if (e.key === 'ArrowRight' && currentFileIndex < allFiles.length - 1) {
            e.preventDefault();
            navigateFile('next');
        }

        // Delete key = Open delete confirmation
        if (e.key === 'Delete' && currentFileIndex >= 0) {
            e.preventDefault();
            confirmDeleteFile();
        }

        // Escape = Close modal
        if (e.key === 'Escape') {
            closeDeleteModal();
        }
    });

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}
