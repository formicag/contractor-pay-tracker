AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Contractor Pay Tracking System - Simplified Deployment

Parameters:
  Environment:
    Type: String
    Default: development
    AllowedValues:
      - development
      - production
    Description: Environment name

  LogLevel:
    Type: String
    Default: INFO
    AllowedValues:
      - DEBUG
      - INFO
      - WARNING
      - ERROR
    Description: Lambda function logging level

Globals:
  Function:
    Runtime: python3.12
    Architectures:
      - arm64
    Timeout: 30
    MemorySize: 512
    Environment:
      Variables:
        ENVIRONMENT: !Ref Environment
        LOG_LEVEL: !Ref LogLevel
        TABLE_NAME: !Ref ContractorPayTable
        S3_BUCKET_NAME: !Ref PayFilesBucket

Resources:
  # DynamoDB Table
  ContractorPayTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub contractor-pay-${Environment}
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: GSI2PK
          AttributeType: S
        - AttributeName: GSI2SK
          AttributeType: S
        - AttributeName: GSI3PK
          AttributeType: S
        - AttributeName: GSI3SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: GSI2
          KeySchema:
            - AttributeName: GSI2PK
              KeyType: HASH
            - AttributeName: GSI2SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: GSI3
          KeySchema:
            - AttributeName: GSI3PK
              KeyType: HASH
            - AttributeName: GSI3SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  # S3 Bucket
  PayFilesBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub contractor-pay-files-${Environment}-${AWS::AccountId}
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldVersions
            Status: Enabled
            NoncurrentVersionExpirationInDays: 30
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # Common Layer
  CommonLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: !Sub contractor-pay-common-${Environment}
      Description: Common utilities (DynamoDB, S3, fuzzy matching)
      ContentUri: layers/common/
      CompatibleRuntimes:
        - python3.12
      CompatibleArchitectures:
        - arm64
    Metadata:
      BuildMethod: python3.12

  # File Upload Handler Function
  FileUploadHandlerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub contractor-pay-file-upload-handler-${Environment}
      CodeUri: functions/file_upload_handler/
      Handler: app.lambda_handler
      Description: Handles file uploads to S3 and creates DynamoDB metadata
      Timeout: 30
      MemorySize: 512
      Layers:
        - !Ref CommonLayer
      Policies:
        - S3CrudPolicy:
            BucketName: !Ref PayFilesBucket
        - DynamoDBCrudPolicy:
            TableName: !Ref ContractorPayTable

  # File Processor Function
  FileProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub contractor-pay-file-processor-${Environment}
      CodeUri: functions/file_processor/
      Handler: app.lambda_handler
      Description: Processes Excel files and validates data
      Timeout: 300
      MemorySize: 1024
      Layers:
        - !Ref CommonLayer
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref PayFilesBucket
        - DynamoDBCrudPolicy:
            TableName: !Ref ContractorPayTable

  # Validation Engine Function
  ValidationEngineFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub contractor-pay-validation-engine-${Environment}
      CodeUri: functions/validation_engine/
      Handler: app.lambda_handler
      Description: Validates pay records against business rules
      Timeout: 60
      MemorySize: 512
      Layers:
        - !Ref CommonLayer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ContractorPayTable

Outputs:
  S3BucketName:
    Description: S3 bucket for pay files
    Value: !Ref PayFilesBucket
    Export:
      Name: !Sub ${AWS::StackName}-BucketName

  DynamoDBTableName:
    Description: DynamoDB table name
    Value: !Ref ContractorPayTable
    Export:
      Name: !Sub ${AWS::StackName}-TableName

  FileUploadHandlerFunctionArn:
    Description: File Upload Handler Function ARN
    Value: !GetAtt FileUploadHandlerFunction.Arn
    Export:
      Name: !Sub ${AWS::StackName}-FileUploadHandlerArn

  FileProcessorFunctionArn:
    Description: File Processor Function ARN
    Value: !GetAtt FileProcessorFunction.Arn
    Export:
      Name: !Sub ${AWS::StackName}-FileProcessorArn

  ValidationEngineFunctionArn:
    Description: Validation Engine Function ARN
    Value: !GetAtt ValidationEngineFunction.Arn
    Export:
      Name: !Sub ${AWS::StackName}-ValidationEngineArn
