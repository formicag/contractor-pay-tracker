name: Lambda Function Testing

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:

env:
  AWS_REGION: eu-west-2
  PYTHON_VERSION: '3.12'

jobs:
  unit-tests:
    name: Unit Tests - ${{ matrix.lambda }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        lambda:
          - file_upload_handler
          - file_processor
          - validation_engine
          - report_generator
          - cleanup_handler

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.lambda }}-${{ hashFiles('backend/functions/${{ matrix.lambda }}/requirements.txt', 'backend/layers/common/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.lambda }}-
            ${{ runner.os }}-pip-

      - name: Install common layer dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/layers/common/requirements.txt

      - name: Install Lambda dependencies
        run: |
          if [ -f backend/functions/${{ matrix.lambda }}/requirements.txt ]; then
            pip install -r backend/functions/${{ matrix.lambda }}/requirements.txt
          fi

      - name: Install test dependencies
        run: |
          pip install -r tests/requirements.txt
          pip install pytest-timeout

      - name: Run unit tests for ${{ matrix.lambda }}
        env:
          PYTHONPATH: ${{ github.workspace }}/backend/layers/common/python:${{ github.workspace }}
          AWS_DEFAULT_REGION: ${{ env.AWS_REGION }}
        run: |
          # Run tests if they exist for this Lambda
          if [ -d "tests/unit/test_${{ matrix.lambda }}" ]; then
            pytest tests/unit/test_${{ matrix.lambda }}/ -v --timeout=30
          else
            echo "No tests found for ${{ matrix.lambda }}, skipping..."
          fi

      - name: Generate coverage for ${{ matrix.lambda }}
        env:
          PYTHONPATH: ${{ github.workspace }}/backend/layers/common/python:${{ github.workspace }}
        run: |
          pytest tests/unit/ -v \
            --cov=backend/functions/${{ matrix.lambda }} \
            --cov=backend/layers/common/python/common \
            --cov-report=xml:coverage-${{ matrix.lambda }}.xml \
            --cov-report=term-missing \
            --timeout=30
        continue-on-error: true

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.lambda }}
          path: coverage-${{ matrix.lambda }}.xml

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/layers/common/requirements.txt
          pip install -r tests/requirements.txt
          pip install moto[all] localstack-client

      - name: Start LocalStack
        uses: LocalStack/setup-localstack@v0.2.2
        with:
          image-tag: 'latest'
          install-awslocal: 'true'

      - name: Run integration tests
        env:
          PYTHONPATH: ${{ github.workspace }}/backend/layers/common/python:${{ github.workspace }}
          AWS_DEFAULT_REGION: ${{ env.AWS_REGION }}
          LOCALSTACK_ENDPOINT: http://localhost:4566
        run: |
          if [ -d "tests/integration" ]; then
            pytest tests/integration/ -v --timeout=60
          else
            echo "No integration tests found, skipping..."
          fi

  lambda-package-test:
    name: Lambda Package Build Test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        lambda:
          - file_upload_handler
          - file_processor
          - validation_engine
          - report_generator
          - cleanup_handler

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Package Lambda function
        run: |
          mkdir -p dist/${{ matrix.lambda }}

          # Copy Lambda code
          cp backend/functions/${{ matrix.lambda }}/app.py dist/${{ matrix.lambda }}/

          # Install dependencies if requirements.txt exists
          if [ -f backend/functions/${{ matrix.lambda }}/requirements.txt ]; then
            pip install -r backend/functions/${{ matrix.lambda }}/requirements.txt -t dist/${{ matrix.lambda }}/
          fi

          # Create ZIP package
          cd dist/${{ matrix.lambda }}
          zip -r ../${{ matrix.lambda }}.zip .
          cd ../..

          # Check package size
          SIZE=$(stat -f%z dist/${{ matrix.lambda }}.zip 2>/dev/null || stat -c%s dist/${{ matrix.lambda }}.zip)
          echo "Package size: $SIZE bytes"

          # Warn if package is too large (> 50MB)
          if [ $SIZE -gt 52428800 ]; then
            echo "::warning::Lambda package for ${{ matrix.lambda }} is larger than 50MB ($SIZE bytes)"
          fi

      - name: Upload Lambda package
        uses: actions/upload-artifact@v4
        with:
          name: lambda-package-${{ matrix.lambda }}
          path: dist/${{ matrix.lambda }}.zip

  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [unit-tests, integration-tests]

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-SmokeTests
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install boto3 requests

      - name: Run smoke tests
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
        run: |
          # Create a simple smoke test script
          cat > smoke_test.py << 'EOF'
          import boto3
          import sys

          def test_lambda_functions():
              client = boto3.client('lambda', region_name='${{ env.AWS_REGION }}')

              lambdas = [
                  'file_upload_handler',
                  'file_processor',
                  'validation_engine',
                  'report_generator',
                  'cleanup_handler'
              ]

              failed = []
              for lambda_name in lambdas:
                  try:
                      response = client.get_function(FunctionName=lambda_name)
                      print(f"✓ {lambda_name}: {response['Configuration']['State']}")
                  except Exception as e:
                      print(f"✗ {lambda_name}: {str(e)}")
                      failed.append(lambda_name)

              if failed:
                  print(f"\nFailed Lambda checks: {', '.join(failed)}")
                  sys.exit(1)
              else:
                  print("\n✓ All Lambda functions are healthy")

          if __name__ == '__main__':
              test_lambda_functions()
          EOF

          python smoke_test.py

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [unit-tests, integration-tests, lambda-package-test]

    steps:
      - name: Download all coverage reports
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          path: coverage-reports/

      - name: Combine coverage reports
        run: |
          pip install coverage
          cd coverage-reports
          coverage combine coverage-*.xml || true
          coverage report || echo "Coverage combine not available"

      - name: Post summary
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Tests: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Lambda Package Tests: ${{ needs.lambda-package-test.result }}" >> $GITHUB_STEP_SUMMARY
